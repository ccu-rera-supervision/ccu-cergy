<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Supervision Trafic IDFM - V2</title>
    <style>
        body { background: #000; color: #fff; font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        .header { background: #002244; color: #00bfff; padding: 25px; text-align: center; font-size: 2.5em; border-bottom: 5px solid #00bfff; font-weight: bold; text-transform: uppercase; }
        .alert-list { flex: 1; padding: 20px; overflow-y: auto; }
        .card { background: #111; border-left: 10px solid #28a745; margin-bottom: 20px; padding: 20px; border-radius: 5px; }
        .card.disrupted { border-left-color: #ffcc00; }
        .line-badge { background: #333; color: #fff; padding: 5px 15px; font-weight: bold; border-radius: 4px; margin-right: 15px; font-size: 1.2em; }
        .alert-title { font-size: 1.8em; font-weight: bold; margin-bottom: 10px; display: inline-block; }
        .alert-msg { font-size: 1.4em; color: #ccc; line-height: 1.4; border-top: 1px solid #222; padding-top: 10px; margin-top: 10px; }
        .status { text-align: center; padding: 100px; font-size: 2em; color: #00ff00; }
    </style>
</head>
<body>
    <div class="header">IDFM - ÉTAT DU RÉSEAU (LINE REPORTS)</div>
    <div class="alert-list" id="display">
        <div class="status">Initialisation du contrat d'interface V2...</div>
    </div>

    <script>
        const API_KEY = "7ea58a7fcd5301b0425dd47ea3212ab8640bc0b09c90031a6474e8c6";

        async function update() {
            try {
                // Construction de l'URL basée sur le contrat fourni
                const target = "https://prim.iledefrance-mobilites.fr/marketplace/v2/navitia/line_reports?disable_geojson=true&count=15";
                const url = `https://api.allorigins.win/get?url=${encodeURIComponent(target)}`;
                
                const response = await fetch(url, { 
                    headers: { 'apikey': API_KEY } 
                });
                
                const json = await response.json();
                const data = JSON.parse(json.contents);
                
                let html = "";
                
                if (data.line_reports) {
                    data.line_reports.forEach(report => {
                        const lineName = report.line.code || report.line.name;
                        const color = report.line.color || "333";
                        
                        // On vérifie s'il y a des perturbations (pt_objects)
                        const hasDisruption = report.pt_objects && report.pt_objects.length > 0;
                        
                        html += `
                        <div class="card ${hasDisruption ? 'disrupted' : ''}">
                            <span class="line-badge" style="border-bottom: 4px solid #${color}">${lineName}</span>
                            <span class="alert-title">${hasDisruption ? '⚠️ Perturbation' : '✅ Trafic Normal'}</span>
                            ${hasDisruption ? `<div class="alert-msg">${report.pt_objects[0].name}</div>` : ''}
                        </div>`;
                    });
                    document.getElementById('display').innerHTML = html;
                } else {
                    document.getElementById('display').innerHTML = "<div class='status'>✅ TOUT LE RÉSEAU EST FLUIDE</div>";
                }
            } catch (e) {
                document.getElementById('display').innerHTML = "<div class='status' style='color:red'>Erreur : Vérifiez la connexion au serveur PRIM</div>";
            }
        }

        update();
        setInterval(update, 120000); // Mise à jour toutes les 2 minutes
    </script>
</body>
</html>
