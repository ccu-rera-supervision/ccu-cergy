<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Graphique Poissy</title>
  <link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;800;900&family=Barlow:wght@400;500;600&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --bg:     #1e2330;
      --bg2:    #252b3b;
      --bg3:    #2d3447;
      --border: #353d52;
      --text:   #e8eaf0;
      --muted:  #6b7494;
      --green:  #2ecc71;
      --orange: #e67e22;
      --red:    #e74c3c;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { width: 100%; height: 100%; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Barlow', sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 1rem 2rem 1.5rem;
      gap: 0.8rem;
    }

    /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }
    .header-left { display: flex; flex-direction: column; gap: 0.1rem; }
    .projet-nom {
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 900; font-size: 1rem;
      letter-spacing: 0.14em; text-transform: uppercase;
      color: var(--muted);
    }
    .graphique-nom {
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 700; font-size: 1.6rem;
      letter-spacing: 0.1em; text-transform: uppercase;
      color: white;
    }
    .header-right { display: flex; flex-direction: column; align-items: flex-end; gap: 0.2rem; }
    .horloge {
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 700; font-size: 2rem;
      color: white; letter-spacing: 0.05em;
    }
    .refresh-info { font-size: 0.62rem; color: var(--muted); letter-spacing: 0.05em; }
    .progress-wrap { width: 100%; height: 3px; background: var(--border); border-radius: 2px; overflow: hidden; }
    .progress-bar {
      height: 100%; background: var(--green); border-radius: 2px;
      width: 100%; transform-origin: left; transition: background 0.3s;
    }
    .progress-bar.epuise { background: var(--orange); }

    /* ‚îÄ‚îÄ PLAN ‚îÄ‚îÄ */
    .plan {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 1.5rem 3rem 1.5rem;
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    /* ‚îÄ‚îÄ CAPSULE √âTAT TRAFIC ‚îÄ‚îÄ */
    .trafic-wrap {
      display: flex;
      justify-content: center;
      margin-bottom: 0.8rem;
    }
    .trafic-box { display: flex; align-items: center; justify-content: center; }
    .trafic-capsule {
      padding: 0.35rem 2.5rem;
      border-radius: 10px;
      transition: background 0.5s;
      background: var(--green);
    }
    .trafic-box.fluide        .trafic-capsule { background: var(--green); }
    .trafic-box.retards       .trafic-capsule { background: #8e6020; }
    .trafic-box.perturbe      .trafic-capsule { background: var(--orange); }
    .trafic-box.tres-perturbe .trafic-capsule { background: var(--red); }
    .trafic-box.interrompu    .trafic-capsule { background: var(--red); }
    .trafic-label {
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 900; font-size: 1.4rem;
      color: white; letter-spacing: 0.06em; text-transform: uppercase;
    }

    /* ‚îÄ‚îÄ RAILS ‚îÄ‚îÄ */
    .sens-label { display: none; }
    .rail-fleche {
      position: absolute;
      top: 50%; transform: translateY(-50%);
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 700; font-size: 0.75rem;
      letter-spacing: 0.1em; text-transform: uppercase;
      color: var(--muted);
      background: var(--bg2);
      padding: 0 6px;
      z-index: 2; white-space: nowrap;
    }
    .rail-fleche.droite { right: 0; }
    .rail-fleche.gauche { left: 0; }

    .rail {
      display: flex;
      align-items: center;
      position: relative;
      height: 120px;
    }
    .rail::before {
      content: '';
      position: absolute;
      left: 80px; right: 80px;
      top: 50%; height: 4px;
      background: var(--border);
      z-index: 0;
    }
    .gare {
      flex: 1;
      display: flex; flex-direction: column;
      align-items: center;
      position: relative; z-index: 1;
      gap: 6px;
    }
    .train-badge {
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 800; font-size: 1.05rem;
      letter-spacing: 0.03em;
      background: #1a3a8f; color: white;
      padding: 4px 10px; border-radius: 5px;
      white-space: nowrap; min-height: 24px;
      text-align: center;
      transition: opacity 0.3s, background 0.3s;
      opacity: 0;
    }
    .train-badge.visible   { opacity: 1; }
    .train-badge.a-lheure  { background: #1a6b3a; }
    .train-badge.en-retard { background: var(--red); }
    .gare-point {
      width: 38px; height: 38px;
      border-radius: 8px;
      border: 2px solid var(--muted);
      background: var(--bg);
      transition: background 0.5s, border-color 0.5s;
    }
    .gare-point.vert   { background: var(--green);  border-color: var(--green); }
    .gare-point.orange { background: var(--orange); border-color: var(--orange); }
    .gare-point.rouge  { background: var(--red);    border-color: var(--red); }
    .gare-point.gris   { background: #2a2f3f; border-color: #3a4052; border-style: dashed; }
    .gare-point.load   { background: #2a3050; border-color: #3a4060; }
    .gare-info { display: flex; flex-direction: column; align-items: center; gap: 3px; }
    .gare-heure {
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 700; font-size: 1.2rem;
      text-align: center; transition: color 0.4s;
    }
    .gare-attente {
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 700; font-size: 1rem;
      text-align: center; transition: color 0.4s;
    }
    .vert   { color: var(--green); }
    .orange { color: var(--orange); }
    .rouge  { color: var(--red); }
    .muted  { color: var(--muted); }
    .rail-sep { height: 6px; }
    .noms { display: flex; margin-top: 0.8rem; }
    .nom {
      flex: 1; text-align: center;
      font-size: 0.85rem; color: white;
      font-weight: 700; line-height: 1.5;
    }
    .nom.terminus { color: white; font-weight: 700; }

    /* ‚îÄ‚îÄ COMMUNICATIONS SNCF ‚îÄ‚îÄ */
    .comm-sncf {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      flex-shrink: 0;
    }
    .comm-sncf-title {
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 700; font-size: 0.9rem;
      letter-spacing: 0.1em; text-transform: uppercase;
      color: white; text-align: center;
      padding: 0.4rem 1rem;
      background: var(--bg3);
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: center; gap: 0.5rem;
    }
    .comm-sncf-body { padding: 0.7rem 1.2rem; min-height: 44px; }
    .no-comm { color: var(--muted); font-size: 0.85rem; text-align: center; padding: 0.3rem 0; }
    .comm-msg {
      font-size: 0.88rem; line-height: 1.6;
      color: var(--text);
      border-left: 3px solid var(--orange);
      padding-left: 0.8rem;
    }
    .comm-msg.interrompu { border-color: var(--red); }
    .comm-time { font-size: 0.72rem; color: var(--muted); text-align: right; margin-top: 0.3rem; }

    /* Carrousel */
    .carousel-wrap { position: relative; }
    .carousel-slide { display: none; }
    .carousel-slide.active { display: block; }
    .carousel-dots { display: flex; justify-content: center; gap: 6px; margin-top: 0.4rem; }
    .carousel-dot {
      width: 7px; height: 7px; border-radius: 50%;
      background: var(--border); transition: background 0.3s;
    }
    .carousel-dot.active { background: var(--muted); }

    /* ‚îÄ‚îÄ L√âGENDE ‚îÄ‚îÄ */
    .legende {
      display: flex; gap: 1.5rem;
      flex-wrap: wrap; justify-content: center;
      font-size: 0.7rem; color: var(--muted);
      flex-shrink: 0;
    }
    .leg-item { display: flex; align-items: center; gap: 0.4rem; }
    .leg-dot { width: 13px; height: 13px; border-radius: 3px; border: 2px solid currentColor; }
    .leg-dot.vert    { color: var(--green);  background: var(--green); }
    .leg-dot.orange  { color: var(--orange); background: var(--orange); }
    .leg-dot.rouge   { color: var(--red);    background: var(--red); }
    .leg-dot.gris    { color: #444; background: #2a2f3f; border-style: dashed; }
  </style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div class="header-left">
    <div class="projet-nom">OPERA ‚Äî Supervision RER A Ouest</div>
    <div class="graphique-nom">Graphique Poissy</div>
  </div>
  <div class="header-right">
    <div class="horloge" id="horloge">--:--</div>
    <div class="refresh-info" id="refresh-info">Chargement‚Ä¶</div>
    <div class="progress-wrap">
      <div class="progress-bar" id="progress-bar"></div>
    </div>
  </div>
</div>

<!-- PLAN DE LIGNE -->
<div class="plan">

  <!-- CAPSULE √âTAT TRAFIC -->
  <div class="trafic-wrap">
    <div class="trafic-box fluide" id="trafic-box">
      <div class="trafic-capsule">
        <span class="trafic-label" id="trafic-label">Chargement‚Ä¶</span>
      </div>
    </div>
  </div>

  <!-- TRAIT 1 -->
  <div class="sens-label">‚Üí Trait 1 ‚Äî Sens Paris</div>
  <div class="rail">
    <div class="rail-fleche gauche">Sens Paris</div>
    <div class="rail-fleche droite">‚Üí</div>
    <div class="gare">
      <div class="train-badge" id="bdg-1-poissy"></div>
      <div class="gare-point load" id="pt-1-poissy"></div>
      <div class="gare-info">
        <div class="gare-heure muted" id="heure-1-poissy">--:--</div>
        <div class="gare-attente muted" id="att-1-poissy">‚Ä¶</div>
      </div>
    </div>
    <div class="gare">
      <div class="train-badge" id="bdg-1-agc"></div>
      <div class="gare-point load" id="pt-1-agc"></div>
      <div class="gare-info">
        <div class="gare-heure muted" id="heure-1-agc">--:--</div>
        <div class="gare-attente muted" id="att-1-agc">‚Ä¶</div>
      </div>
    </div>
    <div class="gare">
      <div class="train-badge" id="bdg-1-ml"></div>
      <div class="gare-point load" id="pt-1-ml"></div>
      <div class="gare-info">
        <div class="gare-heure muted" id="heure-1-ml">--:--</div>
        <div class="gare-attente muted" id="att-1-ml">‚Ä¶</div>
      </div>
    </div>
    <div class="gare">
      <div class="train-badge" id="bdg-1-sartr"></div>
      <div class="gare-point load" id="pt-1-sartr"></div>
      <div class="gare-info">
        <div class="gare-heure muted" id="heure-1-sartr">--:--</div>
        <div class="gare-attente muted" id="att-1-sartr">‚Ä¶</div>
      </div>
    </div>
    <div class="gare">
      <div class="train-badge" id="bdg-1-houilles"></div>
      <div class="gare-point load" id="pt-1-houilles"></div>
      <div class="gare-info">
        <div class="gare-heure muted" id="heure-1-houilles">--:--</div>
        <div class="gare-attente muted" id="att-1-houilles">‚Ä¶</div>
      </div>
    </div>
  </div>

  <div class="rail-sep"></div>

  <!-- TRAIT 2 -->
  <div class="rail">
    <div class="rail-fleche gauche">‚Üê</div>
    <div class="rail-fleche droite">Sens Poissy</div>
    <div class="gare">
      <div class="train-badge" style="opacity:0"></div>
      <div class="gare-point gris"></div>
      <div class="gare-info">
        <div class="gare-heure muted">‚Äî</div>
        <div class="gare-attente muted">Terminus</div>
      </div>
    </div>
    <div class="gare">
      <div class="train-badge" id="bdg-2-agc"></div>
      <div class="gare-point load" id="pt-2-agc"></div>
      <div class="gare-info">
        <div class="gare-heure muted" id="heure-2-agc">--:--</div>
        <div class="gare-attente muted" id="att-2-agc">‚Ä¶</div>
      </div>
    </div>
    <div class="gare">
      <div class="train-badge" id="bdg-2-ml"></div>
      <div class="gare-point load" id="pt-2-ml"></div>
      <div class="gare-info">
        <div class="gare-heure muted" id="heure-2-ml">--:--</div>
        <div class="gare-attente muted" id="att-2-ml">‚Ä¶</div>
      </div>
    </div>
    <div class="gare">
      <div class="train-badge" id="bdg-2-sartr"></div>
      <div class="gare-point load" id="pt-2-sartr"></div>
      <div class="gare-info">
        <div class="gare-heure muted" id="heure-2-sartr">--:--</div>
        <div class="gare-attente muted" id="att-2-sartr">‚Ä¶</div>
      </div>
    </div>
    <div class="gare">
      <div class="train-badge" id="bdg-2-houilles"></div>
      <div class="gare-point load" id="pt-2-houilles"></div>
      <div class="gare-info">
        <div class="gare-heure muted" id="heure-2-houilles">--:--</div>
        <div class="gare-attente muted" id="att-2-houilles">‚Ä¶</div>
      </div>
    </div>
  </div>

  <!-- NOMS GARES -->
  <div class="noms">
    <div class="nom terminus">Poissy</div>
    <div class="nom">Ach√®res<br>Gc</div>
    <div class="nom">Maisons<br>Laffitte</div>
    <div class="nom">Sartrouville</div>
    <div class="nom">Houilles<br>Carr. s/S</div>
  </div>

</div>

<!-- COMMUNICATIONS SNCF -->
<div class="comm-sncf">
  <div class="comm-sncf-title">
    <span>üì°</span> Communication SNCF
  </div>
  <div class="comm-sncf-body" id="panel-comm-sncf">
    <div class="no-comm">Chargement‚Ä¶</div>
  </div>
</div>

<!-- L√âGENDE -->
<div class="legende">
  <div class="leg-item"><div class="leg-dot vert"></div> Prochain train disponible</div>
  <div class="leg-item"><div class="leg-dot orange"></div> Attente mod√©r√©e</div>
  <div class="leg-item"><div class="leg-dot rouge"></div> Attente longue</div>
  <div class="leg-item"><div class="leg-dot gris"></div> Terminus</div>
</div>

<script>
  var PROXY       = 'https://rera-proxy.sammy-avcuoglu.workers.dev/proxy';
  var LINE        = 'STIF:Line::C01742:';
  var LINE_NAVITIA = 'IDFM:C01742';
  var INTERVALLE  = 45000;

  var STOPS = {
    poissy:   'STIF:StopArea:SP:47874:',
    agc:      'STIF:StopArea:SP:47915:',
    ml:       'STIF:StopArea:SP:65048:',
    sartr:    'STIF:StopArea:SP:43191:',
    houilles: 'STIF:StopArea:SP:43082:'
  };

  var FILTRE_PARIS = {
    poissy:   ['boissy', 'marne', 'torcy', 'chessy', 'defense', 'd√©fense'],
    agc:      ['boissy', 'marne', 'torcy', 'chessy', 'defense', 'd√©fense'],
    ml:       ['boissy', 'marne', 'torcy', 'chessy', 'defense', 'd√©fense'],
    sartr:    ['boissy', 'marne', 'torcy', 'chessy', 'defense', 'd√©fense'],
    houilles: ['boissy', 'marne', 'torcy', 'chessy', 'defense', 'd√©fense']
  };
  var FILTRE_POISSY = ['poissy'];

  var traficSNCFState = 'fluide';
  var carousels = {};

  // ‚îÄ‚îÄ HORLOGE ‚îÄ‚îÄ
  function majHorloge() {
    var now = new Date();
    var h = now.getHours(), m = now.getMinutes(), s = now.getSeconds();
    document.getElementById('horloge').textContent =
      (h<10?'0'+h:h)+':'+(m<10?'0'+m:m)+':'+(s<10?'0'+s:s);
  }
  setInterval(majHorloge, 1000);
  majHorloge();

  // ‚îÄ‚îÄ BARRE DE PROGRESSION ‚îÄ‚îÄ
  var progressStart = null;
  var progressRAF   = null;
  function demarrerBarre() {
    progressStart = Date.now();
    var bar = document.getElementById('progress-bar');
    bar.classList.remove('epuise');
    function animer() {
      var pct = Math.min((Date.now() - progressStart) / INTERVALLE, 1);
      bar.style.transform = 'scaleX(' + (1 - pct) + ')';
      if (pct >= 0.85) bar.classList.add('epuise');
      if (pct < 1) progressRAF = requestAnimationFrame(animer);
    }
    if (progressRAF) cancelAnimationFrame(progressRAF);
    progressRAF = requestAnimationFrame(animer);
  }

  // ‚îÄ‚îÄ UTILITAIRES ‚îÄ‚îÄ
  function formatHeure(isoStr) {
    if (!isoStr) return '--:--';
    var d = new Date(isoStr);
    var h = d.getHours(), m = d.getMinutes();
    return (h<10?'0'+h:h)+'h'+(m<10?'0'+m:m);
  }
  function minutesDepuis(isoStr) {
    if (!isoStr) return null;
    return Math.round((new Date(isoStr) - new Date()) / 60000);
  }
  function couleur(attMin) {
    if (attMin === null || attMin < 0) return 'muted';
    if (attMin < 5)  return 'vert';
    if (attMin < 15) return 'orange';
    return 'rouge';
  }
  function destinationMatch(destName, filtres) {
    if (!destName) return false;
    var d = destName.toLowerCase();
    for (var i = 0; i < filtres.length; i++) {
      if (d.indexOf(filtres[i]) !== -1) return true;
    }
    return false;
  }
  function esc(str) {
    return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }
  function decodeHtml(str) {
    var t = document.createElement('textarea');
    t.innerHTML = str; return t.value;
  }

  // ‚îÄ‚îÄ √âTAT TRAFIC ‚îÄ‚îÄ
  function applyTraficState() {
    var box   = document.getElementById('trafic-box');
    var label = document.getElementById('trafic-label');
    box.className = 'trafic-box ' + traficSNCFState;
    var labels = {
      'fluide':        'Fluide',
      'perturbe':      'Perturb√©',
      'tres-perturbe': 'Tr√®s perturb√©',
      'interrompu':    'Interrompu'
    };
    label.textContent = labels[traficSNCFState] || 'Fluide';
  }

  // ‚îÄ‚îÄ CARROUSEL ‚îÄ‚îÄ
  function startCarousel(panelId, items) {
    if (carousels[panelId]) { clearInterval(carousels[panelId]); delete carousels[panelId]; }
    if (items.length <= 1) return;
    var idx = 0;
    function showSlide(i) {
      var slides = document.querySelectorAll('#' + panelId + ' .carousel-slide');
      var dots   = document.querySelectorAll('#' + panelId + ' .carousel-dot');
      for (var s = 0; s < slides.length; s++) slides[s].classList.remove('active');
      for (var d = 0; d < dots.length;   d++) dots[d].classList.remove('active');
      if (slides[i]) slides[i].classList.add('active');
      if (dots[i])   dots[i].classList.add('active');
    }
    showSlide(0);
    carousels[panelId] = setInterval(function() { idx = (idx+1) % items.length; showSlide(idx); }, 15000);
  }

  function renderCarousel(panelId, items) {
    if (carousels[panelId]) { clearInterval(carousels[panelId]); delete carousels[panelId]; }
    var comm = document.getElementById(panelId);
    if (!items.length) {
      comm.innerHTML = '<div class="no-comm">Aucun message en cours.</div>';
      return;
    }
    if (items.length === 1) {
      var t = items[0].time ? '<div class="comm-time">' + esc(items[0].time) + '</div>' : '';
      comm.innerHTML = '<div class="comm-msg ' + items[0].cls + '">' + items[0].html + t + '</div>';
      return;
    }
    var html = '<div class="carousel-wrap">';
    for (var i = 0; i < items.length; i++) {
      var t2 = items[i].time ? '<div class="comm-time">' + esc(items[i].time) + '</div>' : '';
      html += '<div class="carousel-slide' + (i===0?' active':'') + '">';
      html += '<div class="comm-msg ' + items[i].cls + '">' + items[i].html + t2 + '</div>';
      html += '</div>';
    }
    html += '</div><div class="carousel-dots">';
    for (var j = 0; j < items.length; j++)
      html += '<div class="carousel-dot' + (j===0?' active':'') + '"></div>';
    html += '</div>';
    comm.innerHTML = html;
    startCarousel(panelId, items);
  }

  // ‚îÄ‚îÄ FETCH SNCF (√©tat trafic + communications) ‚îÄ‚îÄ
  function fetchSNCF() {
    fetch(PROXY + '/v2/navitia/line_reports/lines/' + encodeURIComponent(LINE_NAVITIA) + '/line_reports', {
      headers: { 'Accept': 'application/json' }
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      var disruptions = [];
      try { disruptions = data.disruptions || []; } catch(e) {}

      var hasInterrompu = false, hasTresPerturbe = false, hasPerturbe = false;
      var messages = [];

      for (var i = 0; i < disruptions.length; i++) {
        var d = disruptions[i];
        var tags = d.tags || [];
        var isAscenseur = false;
        for (var t = 0; t < tags.length; t++) { if (tags[t] === 'Ascenseur') { isAscenseur = true; break; } }
        if (isAscenseur) continue;

        var status = (d.status || '').toLowerCase();
        var titre = '', texte = '';
        var msgs = d.messages || [];
        for (var m = 0; m < msgs.length; m++) {
          var ch = (msgs[m].channel && msgs[m].channel.name) || '';
          if (ch === 'titre' && !titre) titre = msgs[m].text || '';
          if (ch === 'moteur' && !texte) {
            texte = decodeHtml((msgs[m].text || '').replace(/<[^>]+>/g, ' ')).replace(/\s+/g, ' ').trim();
          }
        }
        var affichage = texte || titre;
        if (!affichage) continue;

        var pubTime = '';
        try {
          var updated = d.updated_at || (d.application_periods && d.application_periods[0] && d.application_periods[0].begin) || '';
          if (updated) pubTime = 'Publi√© √† ' + new Date(updated).toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
        } catch(e) {}

        var low = affichage.toLowerCase();
        var isInterrompu   = low.indexOf('interrompu') !== -1;
        var isTravaux      = low.indexOf('travaux')    !== -1;
        var isTresPerturbe = low.indexOf('tr√®s perturb√©') !== -1 || low.indexOf('tres perturbe') !== -1;
        var isPerturbe     = low.indexOf('perturb√©') !== -1 || low.indexOf('perturbe') !== -1;

        if (isInterrompu && isTravaux) { messages.push({ titre: titre, texte: affichage, cause: d.cause || '', status: status, time: pubTime }); continue; }
        if (isTravaux && !isInterrompu) { messages.push({ titre: titre, texte: affichage, cause: d.cause || '', status: status, time: pubTime }); continue; }

        if (isInterrompu)        hasInterrompu   = true;
        else if (isTresPerturbe) hasTresPerturbe = true;
        else if (isPerturbe)     hasPerturbe     = true;
        else                     hasPerturbe     = true;

        messages.push({ titre: titre, texte: affichage, cause: d.cause || '', status: status, time: pubTime });
      }

      if (hasInterrompu)        traficSNCFState = 'interrompu';
      else if (hasTresPerturbe) traficSNCFState = 'tres-perturbe';
      else if (hasPerturbe)     traficSNCFState = 'perturbe';
      else                      traficSNCFState = 'fluide';
      applyTraficState();

      var hasActive = false;
      for (var a = 0; a < messages.length; a++) { if (messages[a].status === 'active') { hasActive = true; break; } }
      var filtered = hasActive ? messages.filter(function(x) { return x.status === 'active'; }) : messages;

      var seenTextes = {}, items = [];
      for (var k = 0; k < filtered.length; k++) {
        var key = filtered[k].texte.trim();
        if (seenTextes[key]) continue;
        seenTextes[key] = true;
        var cause2 = filtered[k].cause.toLowerCase();
        var txt2   = filtered[k].texte.toLowerCase();
        var c = (txt2.indexOf('interrompu') !== -1 && cause2 !== 'travaux') ? 'interrompu' : 'perturbe';
        var h = '';
        if (filtered[k].titre) h += '<strong>' + esc(filtered[k].titre) + '</strong><br>';
        h += esc(filtered[k].texte);
        items.push({ cls: c, html: h, time: filtered[k].time });
      }
      renderCarousel('panel-comm-sncf', items);
    })
    .catch(function() {
      traficSNCFState = 'fluide';
      applyTraficState();
    });
  }

  // ‚îÄ‚îÄ FETCH GARE ‚îÄ‚îÄ
  function majGareDOM(trait, gare, data) {
    var pt    = document.getElementById('pt-'    + trait + '-' + gare);
    var badge = document.getElementById('bdg-'   + trait + '-' + gare);
    var heure = document.getElementById('heure-' + trait + '-' + gare);
    var att   = document.getElementById('att-'   + trait + '-' + gare);
    if (!pt || !badge || !heure || !att) return;
    if (!data) {
      pt.className = 'gare-point load';
      badge.className = 'train-badge';
      badge.textContent = '';
      heure.textContent = '--:--'; heure.className = 'gare-heure muted';
      att.textContent = '‚Äî';      att.className   = 'gare-attente muted';
      return;
    }
    var etat = couleur(data.attente);
    pt.className = 'gare-point ' + etat;
    var badgeTxt = data.mission || '?';
    if (data.retard > 0) badgeTxt += ' +' + data.retard + 'min';
    badge.textContent = badgeTxt;
    badge.className = 'train-badge visible ' + (data.retard > 0 ? 'en-retard' : 'a-lheure');
    heure.textContent = data.heureEstimee; heure.className = 'gare-heure ' + etat;
    att.textContent = data.attente <= 0 ? '√Ä quai' : data.attente + ' min';
    att.className = 'gare-attente ' + etat;
  }

  function fetchGare(stopId, filtresDest) {
    return fetch(PROXY + '/stop-monitoring?MonitoringRef=' + encodeURIComponent(stopId), { cache: 'no-store' })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        var visits = [];
        try { visits = data.Siri.ServiceDelivery.StopMonitoringDelivery[0].MonitoredStopVisit || []; } catch(e) {}
        var candidats = [];
        for (var i = 0; i < visits.length; i++) {
          var v = visits[i], j = v.MonitoredVehicleJourney || {}, call = j.MonitoredCall || {};
          var lineRef = ''; try { lineRef = j.LineRef.value; } catch(e) {}
          if (lineRef !== LINE) continue;
          var destName = ''; try { destName = j.DestinationName[0].value; } catch(e) {}
          if (!destinationMatch(destName, filtresDest)) continue;
          var dept = call.ExpectedDepartureTime || call.AimedDepartureTime;
          var aimed = call.AimedDepartureTime;
          if (!dept) continue;
          var attMin = minutesDepuis(dept);
          if (attMin !== null && attMin < -1) continue;
          var retard = 0;
          if (dept && aimed) retard = Math.max(0, Math.round((new Date(dept) - new Date(aimed)) / 60000));
          var mission = ''; try { mission = j.VehicleJourneyName[0].value; } catch(e) {}
          if (!mission) try { mission = j.JourneyNote[0].value; } catch(e) {}
          candidats.push({ mission: mission, heureEstimee: formatHeure(dept), attente: attMin, retard: retard });
        }
        candidats.sort(function(a, b) { return a.attente - b.attente; });
        return candidats.length > 0 ? candidats[0] : null;
      });
  }

  // ‚îÄ‚îÄ FETCH TOUTES LES GARES ‚îÄ‚îÄ
  function fetchAll() {
    document.getElementById('refresh-info').textContent = 'Actualisation‚Ä¶';

    // Appel SNCF (√©tat trafic + communications)
    fetchSNCF();

    // Appels gares
    var taches = [
      { trait:'1', gare:'poissy',   stop: STOPS.poissy,   filtres: FILTRE_PARIS.poissy },
      { trait:'1', gare:'agc',      stop: STOPS.agc,      filtres: FILTRE_PARIS.agc },
      { trait:'1', gare:'ml',       stop: STOPS.ml,       filtres: FILTRE_PARIS.ml },
      { trait:'1', gare:'sartr',    stop: STOPS.sartr,    filtres: FILTRE_PARIS.sartr },
      { trait:'1', gare:'houilles', stop: STOPS.houilles, filtres: FILTRE_PARIS.houilles },
      { trait:'2', gare:'agc',      stop: STOPS.agc,      filtres: FILTRE_POISSY },
      { trait:'2', gare:'ml',       stop: STOPS.ml,       filtres: FILTRE_POISSY },
      { trait:'2', gare:'sartr',    stop: STOPS.sartr,    filtres: FILTRE_POISSY },
      { trait:'2', gare:'houilles', stop: STOPS.houilles, filtres: FILTRE_POISSY }
    ];

    Promise.all(taches.map(function(t) {
      return fetchGare(t.stop, t.filtres)
        .then(function(data) { majGareDOM(t.trait, t.gare, data); })
        .catch(function()    { majGareDOM(t.trait, t.gare, null); });
    })).then(function() {
      var now = new Date();
      var h = now.getHours(), m = now.getMinutes(), s = now.getSeconds();
      document.getElementById('refresh-info').textContent =
        'Actualis√© √† ' + (h<10?'0'+h:h)+':'+(m<10?'0'+m:m)+':'+(s<10?'0'+s:s);
      demarrerBarre();
    });

    setTimeout(fetchAll, INTERVALLE);
  }

  fetchAll();
</script>
</body>
</html>
